# 题库功能设计文档

## 概述

在现有的题目解析应用基础上，新增题库管理功能，允许用户将处理完成的题目（包含知识点匹配信息）直接上传到题库中进行统一管理。

---

## 功能需求

### 1. 题库管理功能

#### 1.1 题目上传到题库
- **触发时机**: 在知识点匹配完成后，用户可选择将题目上传到题库
- **上传内容**: 包含完整的题目信息和知识点匹配结果
- **批量操作**: 支持批量上传所有题目或选择性上传部分题目

#### 1.2 题库浏览
- **题目列表**: 展示题库中的所有题目
- **分类筛选**: 按题型、知识点、上传时间等维度筛选
- **搜索功能**: 支持关键词搜索题目内容
- **分页显示**: 支持大量题目的分页浏览

#### 1.3 题目管理
- **编辑题目**: 可以修改题库中的题目内容和知识点
- **删除题目**: 支持单个或批量删除题目
- **导出功能**: 从题库中导出选定的题目为Excel文件
- **标签管理**: 为题目添加自定义标签便于分类

### 2. 用户界面设计

#### 2.1 新增页面
- **题库首页**: 题库概览和快速操作入口
- **题目列表页**: 展示和管理题库中的题目
- **题目详情页**: 查看和编辑单个题目的详细信息

#### 2.2 现有页面改进
- **完成页面**: 添加"上传到题库"选项
- **导航菜单**: 增加题库入口
- **步骤指示器**: 可选的第6步"上传题库"

---

## 技术架构

### 1. 前端组件设计

#### 1.1 新增组件
```
src/components/QuestionBank/
├── QuestionBankHome.tsx          # 题库首页
├── QuestionList.tsx              # 题目列表
├── QuestionDetail.tsx            # 题目详情
├── QuestionUpload.tsx            # 题目上传组件
├── QuestionFilter.tsx            # 筛选组件
├── QuestionSearch.tsx            # 搜索组件
└── QuestionBatchActions.tsx      # 批量操作组件
```

#### 1.2 数据类型扩展
```typescript
// 题库题目类型
interface QuestionBankItem extends QuizWithKnowledgePoint {
  id: string;                     // 题库中的唯一ID
  uploadTime: string;             // 上传时间
  tags: string[];                 // 自定义标签
  source: string;                 // 来源文档名称
  lastModified: string;           // 最后修改时间
  status: 'active' | 'archived';  // 题目状态
}

// 题库筛选条件
interface QuestionBankFilter {
  type?: string[];                // 题型筛选
  knowledgePoint?: string[];      // 知识点筛选
  tags?: string[];                // 标签筛选
  dateRange?: {                   // 时间范围
    start: string;
    end: string;
  };
  status?: string;                // 状态筛选
}

// 题库搜索参数
interface QuestionBankSearch {
  keyword: string;                // 搜索关键词
  searchIn: ('question' | 'options' | 'answer' | 'knowledgePoint')[];
}
```

### 2. 路由设计

```typescript
// 新增路由
const routes = [
  // 现有路由...
  {
    path: '/question-bank',
    component: QuestionBankHome,
    children: [
      { path: '', component: QuestionList },
      { path: 'detail/:id', component: QuestionDetail },
      { path: 'upload', component: QuestionUpload }
    ]
  }
];
```

### 3. 状态管理

```typescript
// 题库相关状态
interface QuestionBankState {
  questions: QuestionBankItem[];
  totalCount: number;
  currentPage: number;
  pageSize: number;
  filters: QuestionBankFilter;
  searchParams: QuestionBankSearch;
  loading: boolean;
  selectedQuestions: string[];
}
```

---

## 后端API需求

### 1. 题目管理API

#### 1.1 上传题目到题库
```http
POST /api/question-bank/upload
Content-Type: application/json

{
  "questions": QuizWithKnowledgePoint[],
  "source": string,              // 来源文档名称
  "tags": string[]               // 初始标签
}

Response:
{
  "success": boolean,
  "data": {
    "uploadedCount": number,
    "failedCount": number,
    "questionIds": string[]
  },
  "message": string
}
```

#### 1.2 获取题库题目列表
```http
GET /api/question-bank/questions
Query Parameters:
- page: number (页码)
- pageSize: number (每页数量)
- type: string[] (题型筛选)
- knowledgePoint: string[] (知识点筛选)
- tags: string[] (标签筛选)
- dateStart: string (开始时间)
- dateEnd: string (结束时间)
- status: string (状态筛选)
- keyword: string (搜索关键词)
- searchIn: string[] (搜索范围)

Response:
{
  "success": boolean,
  "data": {
    "questions": QuestionBankItem[],
    "totalCount": number,
    "currentPage": number,
    "pageSize": number
  }
}
```

#### 1.3 获取单个题目详情
```http
GET /api/question-bank/questions/:id

Response:
{
  "success": boolean,
  "data": QuestionBankItem
}
```

#### 1.4 更新题目
```http
PUT /api/question-bank/questions/:id
Content-Type: application/json

{
  "question": string,
  "options": string[],
  "answer": string | string[] | number[],
  "type": string,
  "knowledgePoint": KnowledgePoint,
  "tags": string[]
}

Response:
{
  "success": boolean,
  "data": QuestionBankItem,
  "message": string
}
```

#### 1.5 删除题目
```http
DELETE /api/question-bank/questions/:id

Response:
{
  "success": boolean,
  "message": string
}
```

#### 1.6 批量删除题目
```http
DELETE /api/question-bank/questions/batch
Content-Type: application/json

{
  "questionIds": string[]
}

Response:
{
  "success": boolean,
  "data": {
    "deletedCount": number,
    "failedCount": number
  },
  "message": string
}
```

### 2. 统计和分析API

#### 2.1 获取题库统计信息
```http
GET /api/question-bank/statistics

Response:
{
  "success": boolean,
  "data": {
    "totalQuestions": number,
    "questionsByType": {
      "single-choice": number,
      "multiple-choice": number,
      "fill-in-the-blank": number,
      "subjective": number,
      "other": number
    },
    "questionsByKnowledgePoint": {
      [knowledgePointId: string]: number
    },
    "recentUploads": number,      // 最近7天上传数量
    "totalTags": number
  }
}
```

#### 2.2 获取知识点分布
```http
GET /api/question-bank/knowledge-points/distribution

Response:
{
  "success": boolean,
  "data": {
    "byVolume": { [volume: string]: number },
    "byUnit": { [unit: string]: number },
    "byLesson": { [lesson: string]: number },
    "topKnowledgePoints": Array<{
      knowledgePoint: KnowledgePoint,
      questionCount: number
    }>
  }
}
```

### 3. 导出API

#### 3.1 导出题库题目
```http
POST /api/question-bank/export
Content-Type: application/json

{
  "questionIds": string[],       // 要导出的题目ID列表
  "format": "xlsx" | "json",     // 导出格式
  "includeKnowledgePoints": boolean,
  "includeTags": boolean
}

Response:
{
  "success": boolean,
  "data": {
    "downloadUrl": string,       // 文件下载链接
    "filename": string,
    "expiresAt": string         // 链接过期时间
  }
}
```

### 4. 标签管理API

#### 4.1 获取所有标签
```http
GET /api/question-bank/tags

Response:
{
  "success": boolean,
  "data": Array<{
    "tag": string,
    "questionCount": number
  }>
}
```

#### 4.2 为题目添加标签
```http
POST /api/question-bank/questions/:id/tags
Content-Type: application/json

{
  "tags": string[]
}

Response:
{
  "success": boolean,
  "data": QuestionBankItem
}
```

#### 4.3 批量标签操作
```http
POST /api/question-bank/questions/batch/tags
Content-Type: application/json

{
  "questionIds": string[],
  "action": "add" | "remove" | "replace",
  "tags": string[]
}

Response:
{
  "success": boolean,
  "data": {
    "updatedCount": number,
    "failedCount": number
  }
}
```

---

## 数据库设计

### 1. 题库表结构

```sql
-- 题目表
CREATE TABLE question_bank (
  id VARCHAR(36) PRIMARY KEY,
  question TEXT NOT NULL,
  options JSON,                    -- 选项数组
  answer JSON NOT NULL,            -- 答案（可能是字符串、数组或数字数组）
  type ENUM('single-choice', 'multiple-choice', 'fill-in-the-blank', 'subjective', 'other') NOT NULL,
  knowledge_point_id VARCHAR(36),  -- 关联知识点ID
  source VARCHAR(255),             -- 来源文档
  upload_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  status ENUM('active', 'archived') DEFAULT 'active',
  created_by VARCHAR(36),          -- 创建用户ID（如果有用户系统）
  INDEX idx_type (type),
  INDEX idx_knowledge_point (knowledge_point_id),
  INDEX idx_upload_time (upload_time),
  INDEX idx_status (status)
);

-- 知识点表（如果不存在）
CREATE TABLE knowledge_points (
  id VARCHAR(36) PRIMARY KEY,
  topic VARCHAR(255) NOT NULL,
  volume VARCHAR(100),
  unit VARCHAR(100),
  lesson VARCHAR(100),
  sub VARCHAR(255),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY unique_knowledge_point (topic, volume, unit, lesson, sub)
);

-- 标签表
CREATE TABLE question_tags (
  id VARCHAR(36) PRIMARY KEY,
  question_id VARCHAR(36) NOT NULL,
  tag VARCHAR(100) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (question_id) REFERENCES question_bank(id) ON DELETE CASCADE,
  UNIQUE KEY unique_question_tag (question_id, tag),
  INDEX idx_tag (tag)
);
```

---

## 实现计划

### Phase 1: 基础题库功能
1. 创建题库相关组件和页面
2. 实现题目上传功能
3. 实现基础的题目列表和详情页
4. 后端API开发和数据库设计

### Phase 2: 高级功能
1. 实现筛选和搜索功能
2. 添加标签管理
3. 实现批量操作
4. 添加统计和分析功能

### Phase 3: 用户体验优化
1. 性能优化（分页、缓存）
2. 界面美化和交互优化
3. 错误处理和用户反馈
4. 移动端适配

---

## 安全考虑

### 1. 数据安全
- 题目内容的访问权限控制
- 防止SQL注入和XSS攻击
- 文件上传安全检查

### 2. 操作安全
- 批量操作的权限验证
- 删除操作的确认机制
- 操作日志记录

### 3. 性能安全
- API请求频率限制
- 大量数据查询的优化
- 文件导出的大小限制

---

## 总结

题库功能将大大增强应用的实用性，使其从单次处理工具升级为完整的题目管理系统。通过合理的架构设计和API规划，可以确保功能的可扩展性和维护性。

*文档版本: v1.0*  
*创建时间: 2025年1月*