# Migration 2000000000029: Analytics Indexes

## Overview
Migration for NIE-28: Quiz Error Rate Analytics Dashboard

This migration adds performance indexes to the `practice_answers` table to support efficient error rate calculations and analytics queries.

## What This Migration Does

### Indexes Added
1. **idx_practice_answers_quiz_created**
   - Columns: `(quiz_id, created_at)`
   - Purpose: Time-based filtering for quiz analytics
   - Query: `WHERE quiz_id = ? AND created_at >= ?`

2. **idx_practice_answers_quiz_correct_created**
   - Columns: `(quiz_id, is_correct, created_at)`
   - Purpose: Error rate calculations with time filtering
   - Query: `WHERE quiz_id = ? AND is_correct = ? AND created_at >= ?`

3. **idx_practice_answers_session**
   - Columns: `(session_id)`
   - Purpose: Session-based answer retrieval
   - Query: `WHERE session_id = ?`

## How to Run

### Step 1: Check Migration Status
```bash
cd backend/packages/dev/database/schema
hasura migrate status --skip-update-check --endpoint $HASURA_ENDPOINT --admin-secret $HASURA_SECRET --database-name kedge_db
```

Expected output should show migration `2000000000029_add_analytics_indexes` as "Not Present".

### Step 2: Apply Migration
```bash
hasura migrate apply --endpoint $HASURA_ENDPOINT --admin-secret $HASURA_SECRET --database-name kedge_db
```

### Step 3: Verify Indexes Created
Connect to your database and run:
```sql
SELECT
  indexname,
  indexdef
FROM pg_indexes
WHERE tablename = 'practice_answers'
  AND schemaname = 'kedge_practice'
ORDER BY indexname;
```

Expected output:
```
indexname                                    | indexdef
---------------------------------------------|--------------------------------------------------
idx_practice_answers_quiz_correct_created    | CREATE INDEX ... ON ... (quiz_id, is_correct, created_at)
idx_practice_answers_quiz_created            | CREATE INDEX ... ON ... (quiz_id, created_at)
idx_practice_answers_session                 | CREATE INDEX ... ON ... (session_id)
```

### Step 4: Test Performance (Optional)
```sql
-- Test query that will benefit from indexes
EXPLAIN ANALYZE
SELECT
  quiz_id,
  COUNT(*) as total_attempts,
  SUM(CASE WHEN is_correct = false THEN 1 ELSE 0 END) as incorrect_attempts,
  ROUND(100.0 * SUM(CASE WHEN is_correct = false THEN 1 ELSE 0 END) / COUNT(*), 2) as error_rate
FROM kedge_practice.practice_answers
WHERE created_at >= NOW() - INTERVAL '30 days'
GROUP BY quiz_id
ORDER BY error_rate DESC
LIMIT 20;
```

Look for "Index Scan" in the query plan (not "Seq Scan").

## Rollback (If Needed)

If you need to rollback this migration:
```bash
hasura migrate apply --down 1 --endpoint $HASURA_ENDPOINT --admin-secret $HASURA_SECRET --database-name kedge_db
```

This will drop all indexes added by this migration.

## Impact Assessment

### Performance Impact
- ✅ **Minimal**: Index creation is `IF NOT EXISTS`, safe to run multiple times
- ✅ **Non-blocking**: Indexes are created concurrently (no table locks)
- ✅ **Quick**: Should complete in <5 seconds for most databases

### Storage Impact
- Estimated additional storage: ~5-10% of table size per index
- For 10,000 rows: ~200-500 KB per index
- Total overhead: ~600-1500 KB for all 3 indexes

### Query Performance Improvement
- **Before**: Full table scans for analytics queries (O(n))
- **After**: Index scans with time filtering (O(log n))
- **Expected speedup**: 10-100x for typical analytics queries

## Related Files
- Migration: `backend/packages/dev/database/schema/migrations/kedge_db/2000000000029_add_analytics_indexes/`
- Design Doc: `/docs/designs/quiz-error-rate-analytics.md`
- Linear Issue: NIE-28

## Notes
- These indexes support the teacher analytics dashboard (NIE-28)
- All indexes use `IF NOT EXISTS` for idempotency
- Indexes are named following PostgreSQL conventions
- Comments added for documentation
