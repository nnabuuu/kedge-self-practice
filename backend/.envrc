#!/usr/bin/env bash
# Default environment variables for local development
# For production credentials or environment-specific overrides, create .envrc.override
# .envrc.override is gitignored and will not be committed to version control

set -euo pipefail
__prevEnv__="$(env)"

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
export NX_WORKSPACE_ROOT=${DIR}

PATH_add node_modules/.bin
PATH_add tools/bin
PATH_add packages/dev/database/bin

export HASURA_VERSION="2.35.1"
export NATS_VERSION="0.1.1"

export FIXTURE_DIR="${NX_WORKSPACE_ROOT}/tests/fixtures"

export WORKSPACE_NAME="kedge"
export DEV_NETWORK_NAME="kedge_network"
export HASURA_GRAPHQL_SERVER_PORT="28717"
export HASURA_GRAPHQL_ADMIN_SECRET="9AgJckEMHPRgrasj7Ey8jR"
export HASURA_ENDPOINT="http://localhost:28717"
export HASURA_SECRET="9AgJckEMHPRgrasj7Ey8jR"

# Default to local database - override in .envrc.override for other environments
export NODE_DATABASE_URL="postgres://postgres:postgres@127.0.0.1:7543/kedge_db"
export HASURA_GRAPHQL_DATABASE_URL="postgres://postgres:postgres@127.0.0.1:7543/kedge_db"

export JWT_SECRET="111"
export REDIS_DB=0
export REDIS_HOST=localhost
export REDIS_PORT=6379

export API_PORT=8718
export ENABLE_DEBUG_INFO=true
export LOG_LEVEL=debug
export NODE_ENV=development
export QUIZ_STORAGE_PATH="./quiz-storage"

# OpenAI API Configuration
export OPENAI_API_KEY="your-actual-openai-api-key-here"
# Optional: Configure OpenAI base URL and organization
# export OPENAI_BASE_URL="https://api.openai.com/v1"
# export OPENAI_ORGANIZATION="your-org-id"

# Model Configuration for Different Use Cases
# Quiz Parser - Complex task of extracting quiz items from documents
export OPENAI_MODEL_QUIZ_PARSER="gpt-4o"          # Default: gpt-4o (best for complex parsing)
export OPENAI_TEMP_QUIZ_PARSER="0.7"              # Default: 0.7 (some creativity needed)
export OPENAI_MAX_TOKENS_QUIZ_PARSER="4000"       # Default: 4000

# Quiz Renderer - Simpler task of formatting/polishing quiz questions
export OPENAI_MODEL_QUIZ_RENDERER="gpt-4o-mini"   # Default: gpt-4o-mini (cost-effective)
export OPENAI_TEMP_QUIZ_RENDERER="0.3"            # Default: 0.3 (consistent formatting)
export OPENAI_MAX_TOKENS_QUIZ_RENDERER="1000"     # Default: 1000

# Answer Validator - Semantic validation of fill-in-the-blank answers
export OPENAI_MODEL_ANSWER_VALIDATOR="gpt-4o-mini" # Default: gpt-4o-mini (fast validation)
export OPENAI_TEMP_ANSWER_VALIDATOR="0.3"         # Default: 0.3 (consistent judgment)
export OPENAI_MAX_TOKENS_ANSWER_VALIDATOR="500"   # Default: 500

# Knowledge Point Extractor - Extract keywords and match knowledge points
export OPENAI_MODEL_KNOWLEDGE_EXTRACTOR="gpt-4o"  # Default: gpt-4o (accurate extraction)
export OPENAI_TEMP_KNOWLEDGE_EXTRACTOR="0.3"      # Default: 0.3 (consistent extraction)
export OPENAI_MAX_TOKENS_KNOWLEDGE_EXTRACTOR="1000" # Default: 1000

if [[ -f .envrc.override ]]; then
  source_env .envrc.override
fi

# export updated ENV of this file
node "${NX_WORKSPACE_ROOT}/tools/bin/get-env" "${__prevEnv__}" "$(env)" >"${NX_WORKSPACE_ROOT}/.env" &
