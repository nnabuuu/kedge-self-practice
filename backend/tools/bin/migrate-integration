#!/usr/bin/env bash
set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
SCHEMA_DIR="${PROJECT_ROOT}/packages/dev/database/schema"

# Load environment variables
if [[ -f "${PROJECT_ROOT}/.envrc" ]]; then
    source "${PROJECT_ROOT}/.envrc"
fi

# Check required environment variables
if [[ -z "${NODE_DATABASE_URL:-}" ]]; then
    echo "‚ùå NODE_DATABASE_URL is not set"
    echo "   Please set it in .envrc or .envrc.override"
    exit 1
fi

if [[ -z "${HASURA_ENDPOINT:-}" ]]; then
    echo "‚ùå HASURA_ENDPOINT is not set"
    echo "   Please set it in .envrc or .envrc.override"
    exit 1
fi

if [[ -z "${HASURA_SECRET:-}" ]] && [[ -z "${HASURA_GRAPHQL_ADMIN_SECRET:-}" ]]; then
    echo "‚ùå HASURA_SECRET or HASURA_GRAPHQL_ADMIN_SECRET is not set"
    echo "   Please set it in .envrc or .envrc.override"
    exit 1
fi

# Use HASURA_SECRET if set, otherwise fall back to HASURA_GRAPHQL_ADMIN_SECRET
ADMIN_SECRET="${HASURA_SECRET:-${HASURA_GRAPHQL_ADMIN_SECRET}}"

echo "üöÄ Migrating to environment..."
echo "   Database: ${NODE_DATABASE_URL}"
echo "   Hasura: ${HASURA_ENDPOINT}"

cd "${SCHEMA_DIR}"

# Check if Hasura CLI exists
HASURA_CLI="${PROJECT_ROOT}/packages/dev/database/bin/cli-hasura-darwin-arm64-2.35.1"
if [[ ! -f "${HASURA_CLI}" ]]; then
    echo "‚ùå Hasura CLI not found at ${HASURA_CLI}"
    echo "   Run: cd ${PROJECT_ROOT}/packages/dev/database && ./fix-hasura-cli.sh"
    exit 1
fi

# Apply migrations
echo "üì¶ Applying migrations..."
"${HASURA_CLI}" migrate apply \
    --database-name main_db \
    --endpoint "${HASURA_ENDPOINT}" \
    --admin-secret "${ADMIN_SECRET}" \
    --skip-update-check

# Apply metadata if needed
if [[ -d "${SCHEMA_DIR}/metadata" ]]; then
    echo "üìã Applying metadata..."
    "${HASURA_CLI}" metadata apply \
        --endpoint "${HASURA_ENDPOINT}" \
        --admin-secret "${ADMIN_SECRET}" \
        --skip-update-check
fi

echo "‚úÖ Migration to environment complete!"

# Show migration status
echo ""
echo "üìä Migration Status:"
"${HASURA_CLI}" migrate status \
    --database-name main_db \
    --endpoint "${HASURA_ENDPOINT}" \
    --admin-secret "${ADMIN_SECRET}" \
    --skip-update-check